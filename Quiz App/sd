import json
import os

# File path
QUIZ_DATA_FILE = "quiz_data.json"

# Load data from JSON file
def load_data():
    """Load all data (users, scores, questions) from the JSON file."""
    if not os.path.exists(QUIZ_DATA_FILE):
        # Create a new file with default structure if it doesn't exist
        default_data = {
            "users": {},
            "scores": [],
            "questions": []
        }
        with open(QUIZ_DATA_FILE, "w") as file:
            json.dump(default_data, file, indent=4)
        return default_data
    with open(QUIZ_DATA_FILE, "r") as file:
        return json.load(file)

# Save data to JSON file
def save_data(data):
    """Save all data (users, scores, questions) to the JSON file."""
    with open(QUIZ_DATA_FILE, "w") as file:
        json.dump(data, file, indent=4)

# Register a new user
def register_user(data):
    """Register a new user."""
    username = input("Enter a username: ")
    if username in data["users"]:
        print("Username already exists. Please log in.")
        return None
    password = input("Enter a password: ")
    data["users"][username] = {"password": password, "high_score": 0}
    save_data(data)
    print("Registration successful!")
    return username

# Log in an existing user
def login_user(data):
    """Log in an existing user."""
    username = input("Enter your username: ")
    if username not in data["users"]:
        print("Username not found. Please register.")
        return None
    password = input("Enter your password: ")
    if data["users"][username]["password"] != password:
        print("Incorrect password.")
        return None
    print("Login successful!")
    return username

# Update user's high score
def update_high_score(data, username, score):
    """Update the user's high score."""
    if score > data["users"][username]["high_score"]:
        data["users"][username]["high_score"] = score
        save_data(data)
        print(f"New high score for {username}: {score}!")

# Save quiz score
def save_score(data, username, score):
    """Save the user's score to the quiz history."""
    data["scores"].append({"username": username, "score": score})
    save_data(data)

# Get the grand champion
def get_grand_champion(data):
    """Get the user with the highest score across all quizzes."""
    if not data["users"]:
        return None
    grand_champion = max(data["users"].items(), key=lambda x: x[1]["high_score"])
    return grand_champion

# Ask a single question
def ask_question(question_data):
    """Ask a single question and return whether the answer was correct."""
    print(f"\n{question_data['question']}")
    for option in question_data["options"]:
        print(option)
    
    while True:
        answer = input("Enter your answer (A-D): ").upper()
        if answer in ["A", "B", "C", "D"]:
            break
        else:
            print("Invalid input! Please enter A, B, C, or D.")
    
    if answer == question_data["correct_answer"]:
        print("Correct!")
        return True
    else:
        print(f"Incorrect! The correct answer is {question_data['correct_answer']}.")
        return False

# Run the quiz
def run_quiz(data, username):
    """Run the quiz application."""
    print(f"\nHello {username}, welcome to Quizy!")
    print("Let's get started!\n")
    
    # Load questions
    questions = data["questions"]
    if not questions:
        print("No questions found. Please add questions first.")
        return
    
    score = 0  # Initialize score
    
    # Ask each question
    for question in questions:
        if ask_question(question):
            score += 1
    
    # Display final score
    print(f"\n{username}, your final score is {score}/{len(questions)}!")
    
    # Save score and update high score
    save_score(data, username, score)
    update_high_score(data, username, score)
    
    # Display grand champion
    grand_champion = get_grand_champion(data)
    if grand_champion:
        print(f"\nGrand Champion: {grand_champion[0]} with a high score of {grand_champion[1]['high_score']}!")

# Main menu
def main_menu():
    """Display the main menu and handle user choices."""
    data = load_data()
    while True:
        print("\n--- Quizy Main Menu ---")
        print("1. Register")
        print("2. Log In")
        print("3. Exit")
        choice = input("Enter your choice (1-3): ")
        
        if choice == "1":
            username = register_user(data)
            if username:
                run_quiz(data, username)
        elif choice == "2":
            username = login_user(data)
            if username:
                run_quiz(data, username)
        elif choice == "3":
            print("Goodbye!")
            break
        else:
            print("Invalid choice. Please try again.")

# Run the main menu
main_menu()